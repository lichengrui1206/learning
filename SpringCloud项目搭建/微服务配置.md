> 使用Spring-boot:3.0.5

## 父工程 POM

```xml
<dependencyManagement>
    <dependencies>
        <!-- mybatis-plus -->
        <dependency>
            <groupId>com.baomidou</groupId>
            <artifactId>mybatis-plus-spring-boot3-starter</artifactId>
            <version>3.5.5</version>
        </dependency>
        <!-- spring cloud alibaba -->
        <dependency>
            <groupId>com.alibaba.cloud</groupId>
            <artifactId>spring-cloud-alibaba-dependencies</artifactId>
            <version>2022.0.0.0-RC2</version>
            <type>pom</type>
            <scope>import</scope>
        </dependency>
        <!-- OpenFeign - 远程调用 -->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-openfeign</artifactId>
            <version>4.0.4</version>
        </dependency>
        <!-- 负载均衡 -->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-loadbalancer</artifactId>
            <version>4.0.4</version>
        </dependency>
    </dependencies>
</dependencyManagement>
```

## 子项目

### POM

```xml
<!-- 注册中心(nacos) -->
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
</dependency>
<!-- OpenFeign - 远程调用 -->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-openfeign</artifactId>
</dependency>
<!-- 负载均衡 -->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-loadbalancer</artifactId>
</dependency>
```

### yml配置

```yaml
server:
  port: 9001  # 端口配置
spring:
  application:
    name: user-service  # 服务名(在nacos中注册的服务名)
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/demo2_cloud
    username: root
    password: root
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848  # nacos服务地址
mybatis-plus:
  configuration:
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl
```

### OpenFeign使用

在启动类加上以下注解

```java
@EnableFeignClients
```

创建一个远程调度接口，按照实际修改以下内容

```java
@FeignClient("Nacos服务名")
@Component
public interface DeptFeign {
    // 以下内容要与被请求的方式参数等一致
    @GetMapping("调度地址")
    Dept findById(@PathVariable("id") Integer id);
}
```

### 网关

不继承任何父工程，正常书写SpringBoot启动类

#### POM内容

```xml
<parent>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-parent</artifactId>
    <version>3.0.5</version>
    <relativePath/>
</parent>

......

<dependencies>
    <!--网关-->
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-gateway</artifactId>
        <version>4.1.0</version>
    </dependency>
    <!-- spring cloud alibaba -->
    <dependency>
        <groupId>com.alibaba.cloud</groupId>
        <artifactId>spring-cloud-alibaba-dependencies</artifactId>
        <version>2022.0.0.0-RC2</version>
        <type>pom</type>
        <scope>import</scope>
    </dependency>
    <!-- 注册中心(nacos) -->
    <dependency>
        <groupId>com.alibaba.cloud</groupId>
        <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
        <version>2022.0.0.0-RC2</version>
    </dependency>
    <!-- 负载均衡 -->
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-loadbalancer</artifactId>
        <version>4.0.4</version>
    </dependency>
</dependencies>
```

#### yml内容

```yaml
server:
  port: 9000  # 端口配置
spring:
  application:
    name: gateway # 服务名(在nacos中注册的服务名)
  cloud:
    nacos:
      discovery:
        server-addr: 127.0.0.1:8848 # nacos服务地址
    gateway:
      globalcors:
        cors-configurations:
          '[/**]': # 匹配所有请求
            allowedOrigins: "*" #跨域处理 允许所有的域
            allowedMethods: # 支持的方法
              - GET
              - POST
              - PUT
              - DELETE
      routes:
        # 平台管理
        - id: user
          uri: lb://user-service  # 路由的目标地址 lb就是负载均衡，后面跟服务名称
          predicates:
            - Path=/user/** # 这个是按照路径匹配，只要以/user/开头就符合要求
          filters:
            - StripPrefix= 0  # 将路径中的第1段切除

        # 平台管理
        - id: dept # 路由id，自定义，只要唯一即可
          uri: lb://dept-service # 路由的目标地址 lb就是负载均衡，后面跟服务名称
          predicates: # 路由断言，也就是判断请求是否符合路由规则的条件
            - Path=/dept/** # 这个是按照路径匹配，只要以/user/开头就符合要求
          filters:
            - StripPrefix= 0 # 将路径中的第1段切除
```

### Ribbon

#### 使用步骤

##### 引入坐标:

```xml
 		<dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-loadbalancer</artifactId>
            <version>4.0.4</version>
        </dependency>

```

##### yaml配置

```yaml
 cloud:
    nacos:
      discovery:
        server-addr: 127.0.0.1:8848
        cluster-name: H2308A # 集群名称
```

### nacos-配置中心

概念：可以在nacos中编写配置文件,管理所有微服务模块的公有配置

作用：可以在nacos的控制台统一管理配置参数;

#### 使用步骤

##### 在项目中引入坐标;

```xml
<!--nacos配置管理依赖-->
        <dependency>
            <groupId>com.alibaba.cloud</groupId>
            <artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>
            <version>2022.0.0.0-RC2</version>
        </dependency>
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-bootstrap</artifactId>
            <version>4.0.2</version>
        </dependency>
```

#### 手动创建bootstrap.yml文件,并在文件中编写配置信息

```yaml
server:
  port: 8888
spring:
  application:
    name: dept # 服务名称
  profiles:
    active: dev #开发环境，这里是dev
  cloud:
    nacos:
      server-addr: localhost:8848 # Nacos地址
      config:
        file-extension: yaml # 文件后缀名
```

#### 手动在nacos的控制台创建对应的配置文件

![image-20240531110511180](C:\Users\qwxqy\AppData\Roaming\Typora\typora-user-images\image-20240531110511180.png)![image-20240531110722949](C:\Users\qwxqy\AppData\Roaming\Typora\typora-user-images\image-20240531110722949.png)

#### 实现

在代码中读取扩展的配置文件中的数据即可;

```java
	@Value("${student.name}")
    private String name;
    @Value("${student.age}")
    private String age;
    @GetMapping("/testBootStrap")
    public String test01(){
        return name+"---"+age;
    }
```

#### `注意`

子类要继承父类的pom.xml

```xml
	<parent>
        <groupId>cn.jiyun</groupId>
        <artifactId>day03_dept_cloud</artifactId>
        <version>0.0.1-SNAPSHOT</version>
        <!-- 父模块的相对路径 -->
        <relativePath>../pom.xml</relativePath>
    </parent>
```

### 配置集群和访问权重

```tex
集群就是让多个服务做相同的事情;
```

#### 搭建方式

```yaml
在yml的配置文件中添加集群的配置信息即可;
  cloud:
    nacos:
      server-addr: localhost:8848 # Nacos地址
      discovery:
        cluster-name: H2308A
```

### 配置nacos中管理的微服务的权重

![image-20240531160241866](C:\Users\qwxqy\AppData\Roaming\Typora\typora-user-images\image-20240531160241866.png)

#### 代码中开启nacos权重规则

在远程调方开启(微服务的调用者)的配置文件中写如下内容即可:

```yaml
cloud:
    loadbalancer:
      nacos:
        enabled: true
    nacos:
      discovery:
        server-addr: 127.0.0.1:8848
user:
  ribbon:
    NFLoadBalancerRuleClassName: com.alibaba.cloud.nacos.ribbon.NacosRule # 负载均衡规则
```

### 配置文件的热更新

一共两种方式

第一种方式

在需要添加的热更新的类上添加注解@RefreshScope

可以在类中通过 @value注解直接获取配置信息



第二种方式

直接使用模型类即可代码如下

```java
@ConfigurationProperties(prefix = "student")
@Data
@Component
public class Student {
    private String name;
    private Integer age;
}
```

